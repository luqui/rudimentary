<html>
 <head>
  <script src="resources/jquery-3.1.1.min.js"></script>
  <!-- bootstrap stuff -->
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
 </head>
<script>
 $(function() {
  $('#devices_menu_activate').click(function() {
    $.ajax({ url: '/devices' }).then(function(data) {
      $('#devices_menu').empty();
      for (var i in data) {
        (function() {
            var dev = data[i];
            $('#devices_menu').append($('<li>').append(
                $('<a>').append(dev)
                        .attr('href', '#')
                        .click(function() {
                            $('#current_device').text(dev);
                        })));
        })();
      }
    });
  });

  $('#levels_menu_activate').click(function() {
    $.ajax({ url: '/levels' }).then(function(data) {
      $('#levels_menu').empty();
      for (var i in data) {
        (function() {
          var level = data[i];
          $('#levels_menu').append($('<li>').append(
            $('<a>').append(level)
                    .attr('href', '#')
                    .click(function() {
                        $('#current_level').text(level);
                        load_level(level);
                    })));
        })();
      }
    });
  });

  var load_level = function(levelname) {
    $('#levelcontent').empty();
    $.ajax({ url: '/level?name=' + encodeURIComponent(levelname) }).then(function(data) {
        var input = $('<input>').attr('type', 'text').addClass('form-control');
        var errorbox = $('<div>');
        var button = $('<button>').addClass('btn btn-primary').text('Submit');

        $('#levelcontent').append(
            $('<h2>').text(data.name),
            $('<p>').html(data.desc),
            $('<div>').addClass('row').append(
                $('<div>').addClass('col-md-8').append(input),
                $('<div>').addClass('col-md-4').append(button)),
            errorbox);

        var submit = function() {
          if ($('#current_device').text() == "none") {
            alert('You must select a MIDI device');
            return;
          }
          errorbox.empty();
          $.ajax({ url: '/trylevel?dev=' + encodeURIComponent($('#current_device').text())
                               + '&tempo=' + encodeURIComponent($('#tempo').val())
                               + '&session=' + encodeURIComponent(data.session)
                               + '&answer=' + encodeURIComponent(input.val()) }).then(function(response) {
                if ('correct' in response && response.correct) {
                  errorbox.append(
                    $('<div>').addClass('alert alert-success').html(
                      "Correct!<br>Notation:<pre>" + response.notation + "</pre>"));
                  input.val('');
                }
                else if ('correct' in response && !response.correct) {
                  errorbox.append(
                    $('<div>').addClass('alert alert-danger').text('Incorrect!'));
                }
              });
        };
        button.click(submit);
        input.keyup(function(e) {
          if(e.keyCode == 13) {
            submit();
          }
        });
    });         
  };
 });
</script>
 <body>
  <div class="container">
   <div class="row">
    <div class="col-md-6">
     <div class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" id="devices_menu_activate">MIDI Device: <span id="current_device">none</span><span class="caret"></span></a>
      <ul class="dropdown-menu" id="devices_menu">
      </ul>
     </div>

     <div class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" id="levels_menu_activate">Level: <span id="current_level">none</span><span class="caret"></span></a>
      <ul class="dropdown-menu" id="levels_menu">
      </ul>
     </div>
    </div>
    <div class="col-md-6">
     Tempo <input id="tempo" value="60" size="4" /> bpm
    </div>
   </div>

   <div id="levelcontent">
   </div> 
  </div>
 </body>
</html>
